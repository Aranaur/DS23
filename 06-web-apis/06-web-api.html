<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Webscraping: API</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="06-web-api_files/libs/clipboard/clipboard.min.js"></script>
<script src="06-web-api_files/libs/quarto-html/quarto.js"></script>
<script src="06-web-api_files/libs/quarto-html/popper.min.js"></script>
<script src="06-web-api_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="06-web-api_files/libs/quarto-html/anchor.min.js"></script>
<link href="06-web-api_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="06-web-api_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="06-web-api_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="06-web-api_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="06-web-api_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="06-web-api_files/libs/htmlwidgets-1.6.1/htmlwidgets.js"></script>
<link href="06-web-api_files/libs/jsoneditor-5.25.6/jsoneditor.min.css" rel="stylesheet">
<script src="06-web-api_files/libs/jsoneditor-5.25.6/jsoneditor.min.js"></script>
<script src="06-web-api_files/libs/jsonedit-binding-3.0.0/jsonedit.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#реєстрація-та-програмне-забезпечення" id="toc-реєстрація-та-програмне-забезпечення" class="nav-link active" data-scroll-target="#реєстрація-та-програмне-забезпечення">Реєстрація та програмне забезпечення</a></li>
  <li><a href="#резюме-минулого-разу" id="toc-резюме-минулого-разу" class="nav-link" data-scroll-target="#резюме-минулого-разу">Резюме минулого разу</a></li>
  <li><a href="#на-стороні-клієнта-api-та-кінцеві-точки-api" id="toc-на-стороні-клієнта-api-та-кінцеві-точки-api" class="nav-link" data-scroll-target="#на-стороні-клієнта-api-та-кінцеві-точки-api">На стороні клієнта, API та кінцеві точки API</a></li>
  <li><a href="#застосування-1-дерева-нью-йорка" id="toc-застосування-1-дерева-нью-йорка" class="nav-link" data-scroll-target="#застосування-1-дерева-нью-йорка">Застосування 1: Дерева Нью-Йорка</a></li>
  <li><a href="#застосування-2-fred-data" id="toc-застосування-2-fred-data" class="nav-link" data-scroll-target="#застосування-2-fred-data">Застосування 2: FRED data</a></li>
  <li><a href="#застосування-3-світовий-рейтинг-з-регбі" id="toc-застосування-3-світовий-рейтинг-з-регбі" class="nav-link" data-scroll-target="#застосування-3-світовий-рейтинг-з-регбі">Застосування 3: Світовий рейтинг з регбі</a></li>
  <li><a href="#додаткові-ресурси-та-вправи" id="toc-додаткові-ресурси-та-вправи" class="nav-link" data-scroll-target="#додаткові-ресурси-та-вправи">Додаткові ресурси та вправи</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Webscraping: API</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="реєстрація-та-програмне-забезпечення" class="level1">
<h1>Реєстрація та програмне забезпечення</h1>
<section id="зареєструватися" class="level2">
<h2 class="anchored" data-anchor-id="зареєструватися">Зареєструватися</h2>
<p>Ми будемо завантажувати економічні дані з <code>FRED API</code>. Для цього потрібно спочатку <a href="https://research.stlouisfed.org/useraccount/apikey">створити обліковий запис користувача</a>, а потім <a href="https://research.stlouisfed.org/useraccount/apikey">зареєструвати особистий ключ API</a>.</p>
</section>
<section id="зовнішнє-програмне-забезпечення" class="level2">
<h2 class="anchored" data-anchor-id="зовнішнє-програмне-забезпечення">Зовнішнє програмне забезпечення</h2>
<p>Сьогодні я буду використовувати <a href="https://jsonview.com/">JSONView</a>, розширення для браузера, яке відтворює вивід JSON.</p>
</section>
<section id="пакети-r" class="level2">
<h2 class="anchored" data-anchor-id="пакети-r">Пакети R</h2>
<ul>
<li>Нові: <code>jsonlite</code>, <code>httr</code>, <code>listviewer</code>, <code>usethis</code>, <code>fredr</code></li>
<li>Вже відомі: <code>tidyverse</code>, <code>lubridate</code>, <code>hrbrthemes</code>, <code>janitor</code></li>
</ul>
<p>Ось зручний спосіб інсталювати (за потреби) і завантажити всі перераховані вище пакети.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Завантажте та встановіть пакети, які ми будемо використовувати сьогодні</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, httr, lubridate, hrbrthemes, janitor, jsonlite, fredr, </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>               listviewer, usethis)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Моя улюблена тема ggplot2 (необов’язково)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(hrbrthemes<span class="sc">::</span><span class="fu">theme_ipsum</span>())</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">readRenviron</span>(<span class="st">"~/.Renviron"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="резюме-минулого-разу" class="level1">
<h1>Резюме минулого разу</h1>
<p>Під час минулої лекції ми побачили, що веб-сайти та веб-додатки поділяються на дві категорії: 1) серверні та 2) клієнтські. Потім ми практикували збирати дані, які належать до першої категорії — тобто відтворені на стороні сервера — за допомогою пакета <code>rvest.</code> Ця техніка зосереджена на селекторах CSS (за допомогою <code>SelectorGadget</code>) і тегах HTML. Велика кількість параметрів CSS і гнучкість самого HTML означає, що кроки, які ідеально працюють на одному веб-сайті, можуть легко зазнати невдачі на іншому веб-сайті.</p>
<p>Сьогодні ми зосередимося на другій категорії: аналіз веб-даних, які відображаються на стороні клієнта. Хороша новина полягає в тому, що цей підхід, якщо він доступний, зазвичай значно полегшує отримання даних з Інтернету. Недоліком є те, що, знову ж таки, це може включати стільки ж мистецтва, скільки науки.</p>
</section>
<section id="на-стороні-клієнта-api-та-кінцеві-точки-api" class="level1">
<h1>На стороні клієнта, API та кінцеві точки API</h1>
<p>Пам’ятайте, що веб-сайти або програми, створені за допомогою фреймворку <strong>на стороні клієнта</strong>, зазвичай передбачають такі кроки:</p>
<ul>
<li>Ви відвідуєте URL-адресу, яка містить шаблон статичного вмісту (таблиці HTML, CSS тощо). Цей шаблон сам по собі не містить жодних даних.</li>
<li>Однак у процесі відкриття URL-адреси ваш браузер надсилає <em>запит</em> на сервер хосту.</li>
<li>Якщо ваш запит дійсний, сервер видає <em>відповідь</em>, і ви отримуєте необхідні дані, які динамічно відображає сторінка у вашому браузері. – Сторінка, яку ви фактично бачите у своєму браузері, є сумішшю статичного вмісту та динамічної інформації, яку відображає ваш браузер (тобто «клієнт»).</li>
</ul>
<p>Усі ці запити, відповіді та візуалізація відбуваються через <strong>API</strong> головної програми (або <strong>A</strong>pplication <strong>P</strong>rogram <strong>I</strong>nterface).</p>
<section id="api" class="level2">
<h2 class="anchored" data-anchor-id="api">API</h2>
<p>Якщо ви новачок у API або читаєте це після факту, я рекомендую цей чудовий ресурс від Zapier: <a href="https://zapier.com/learn/apis/">An Introduction to APIs</a>. Це досить глибока публікація, але вам не потрібно вивчати все, щоб зрозуміти суть. Коротка версія полягає в тому, що API – це просто набір правил і методів, які дозволяють різним програмам програмного забезпечення взаємодіяти та обмінюватися інформацією. Це стосується не лише веб-серверів і браузерів, а й пакетів програмного забезпечення, таких як бібліотеки R, які ми використовуємо<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Основні поняття включають:</p>
<ul>
<li><strong>Сервер</strong>: потужний комп’ютер, на якому працює API.</li>
<li><strong>Клієнт</strong>: програма, яка обмінюється даними з сервером через API.</li>
<li><strong>Протокол</strong>: «етикет», який лежить в основі того, як комп’ютери спілкуються один з одним (наприклад, HTTP).</li>
<li><strong>Методи</strong>: «дієслова», які клієнти використовують для спілкування з сервером. Основний метод, який ми будемо використовувати, — це <code>GET</code> (тобто запит серверу отримати інформацію), але інші поширені методи — це <code>POST</code>, <code>PUT</code> і <code>DELETE</code>.</li>
<li><strong>Запити</strong>: Те, що клієнт запитує у сервера (див. Методи вище).</li>
<li><strong>Відповідь</strong>: відповідь сервера. Включає <em>Status Code</em> (наприклад, «404», якщо не знайдено, або «200», якщо вдалося), <em>Header</em> (тобто метаінформація про відповідь) і <em>Body</em> (тобто фактичний вміст, який нас цікавить).</li>
<li>тощо</li>
</ul>
</section>
<section id="ще-трохи-про-кінцеві-точки-api" class="level2">
<h2 class="anchored" data-anchor-id="ще-трохи-про-кінцеві-точки-api">Ще трохи про кінцеві точки API</h2>
<p>Ключовим моментом у всьому цьому є те, що у випадку веб-API ми можемо отримати доступ до інформації безпосередньо з бази даних API, якщо зможемо вказати правильну URL-адресу. Ці URL-адреси відомі як кінцеві точки API (анг. <em>API endpoints</em>).</p>
<p>Кінцеві точки API багато в чому схожі на звичайні URL-адреси веб-сайтів, які ми всі звикли відвідувати. Для початку ви можете перейти до них у своєму веб-браузері. Однак у той час як звичайні веб-сайти відображають інформацію у насиченому вмісті HTML — зображення, відео з котами, гарне форматування тощо — кінцева точка API набагато менш приваблива візуально. Перейдіть у веб-переглядачі до кінцевої точки API, і ви побачите купу, здавалося б, неформатованого тексту. По правді кажучи, ви бачите (ймовірно) або JSON (нотація об’єктів JavaScript), або XML (розширювана мова розмітки).</p>
<p>Вам не потрібно надто турбуватися про синтаксис JSON і XML. Важливо те, що об’єкт у вашому браузері — цей набір, здавалося б, неформатованого тексту — насправді дуже точно структурований і відформатований. Крім того, він містить цінну інформацію, яку ми можемо легко прочитати в R (або Python, Julia тощо). Нам просто потрібно знати правильну кінцеву точку API для даних, які нам потрібні.</p>
<p>Давайте попрактикуємося робити це на кількох прикладах програм. Я почну з найпростішого випадку (ключ API не потрібен, явна кінцева точка API), а потім розгляну кілька складніших прикладів.</p>
</section>
</section>
<section id="застосування-1-дерева-нью-йорка" class="level1">
<h1>Застосування 1: Дерева Нью-Йорка</h1>
<p><a href="https://opendata.cityofnewyork.us/">NYC Open Data</a> це досить дивовижна ініціатива. Його місія полягає в тому, щоб «зробити велику кількість загальнодоступних даних, створених різними агентствами міста Нью-Йорка та іншими організаціями міста, доступними для загального користування». Ви можете отримати дані про все: від даних про арешт, до розташування точок доступу Wi-Fi, від оголошень про роботу в місті до підрахунку кількості бездомних, від ліцензій на собак, до каталогу туалетів у громадських парках… Список можна продовжувати. Я наполегливо заохочую вас дослідити ці дані у вільний час, але ми збираємося зробити щось «земне» для цієї першої програми: завантажте зразок даних про дерева з <a href="https:/%20/data.cityofnewyork.us/Environment/2015-Street-Tree-Census-Tree-Data/uvpi-gqnh"><strong>2015 NYC Street Tree Census</strong></a>.</p>
<p>Я хотів почати з прикладу з відкритих даних Нью-Йорка, тому що вам не потрібно налаштовувати ключ API заздалегідь<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.(https://data.cityofnewyork.us/profile/app_tokens) для отримання токена програми NYC Open Data. Все, що вам потрібно зробити, це виконати наступні кроки:</p>
<ul>
<li>Відкрийте <a href="https://data.cityofnewyork.us/Environment/2015-Street-Tree-Census-Tree-Data/uvpi-gqnh">веб-сторінку</a> у своєму браузері (якщо ви ще цього не зробили).</li>
<li>Ви маєте побачити вкладку <strong>API</strong>. Натисніть на неї.</li>
<li>Скопіюйте <a href="https://data.cityofnewyork.us/resource/uvpi-gqnh.json">кінцеву точку API</a>, яка з’явиться у спливаючому вікні.</li>
<li><em>Необов’язково:</em> Вставте цю кінцеву точку в нову вкладку у своєму браузері. Ви побачите купу тексту JSON, який можна гарно відобразити за допомогою розширення браузера JSONView, яке ми встановили раніше.</li>
</ul>
<p>Тепер, коли ми знайшли кінцеву точку API, давайте прочитаємо дані в R. Ми зробимо це за допомогою функції <code>fromJSON()</code> з чудового пакету <strong>jsonlite</strong> (<a href="https://cran.%20r-project.org/web/packages/jsonlite/index.html">link</a>). Це автоматично перетворить масив JSON на звичайний дата фрейм R. Однак я піду ще трохи далі і перетворю його на тібл, оскільки з ним приємніше працювати.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>nyc_trees <span class="ot">=</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>(<span class="st">"https://data.cityofnewyork.us/resource/uvpi-gqnh.json"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>nyc_trees</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,000 × 45
   tree_id block_id created_at        tree_dbh stump_diam curb_loc status health
   &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;             &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
 1 180683  348711   2015-08-27T00:00… 3        0          OnCurb   Alive  Fair  
 2 200540  315986   2015-09-03T00:00… 21       0          OnCurb   Alive  Fair  
 3 204026  218365   2015-09-05T00:00… 3        0          OnCurb   Alive  Good  
 4 204337  217969   2015-09-05T00:00… 10       0          OnCurb   Alive  Good  
 5 189565  223043   2015-08-30T00:00… 21       0          OnCurb   Alive  Good  
 6 190422  106099   2015-08-30T00:00… 11       0          OnCurb   Alive  Good  
 7 190426  106099   2015-08-30T00:00… 11       0          OnCurb   Alive  Good  
 8 208649  103940   2015-09-07T00:00… 9        0          OnCurb   Alive  Good  
 9 209610  407443   2015-09-08T00:00… 6        0          OnCurb   Alive  Good  
10 192755  207508   2015-08-31T00:00… 21       0          OffsetF… Alive  Fair  
# ℹ 990 more rows
# ℹ 37 more variables: spc_latin &lt;chr&gt;, spc_common &lt;chr&gt;, steward &lt;chr&gt;,
#   guards &lt;chr&gt;, sidewalk &lt;chr&gt;, user_type &lt;chr&gt;, problems &lt;chr&gt;,
#   root_stone &lt;chr&gt;, root_grate &lt;chr&gt;, root_other &lt;chr&gt;, trunk_wire &lt;chr&gt;,
#   trnk_light &lt;chr&gt;, trnk_other &lt;chr&gt;, brch_light &lt;chr&gt;, brch_shoe &lt;chr&gt;,
#   brch_other &lt;chr&gt;, address &lt;chr&gt;, zipcode &lt;chr&gt;, zip_city &lt;chr&gt;,
#   cb_num &lt;chr&gt;, borocode &lt;chr&gt;, boroname &lt;chr&gt;, cncldist &lt;chr&gt;, …</code></pre>
</div>
</div>
<p><strong>Певні обмеження:</strong> Зверніть увагу, що повний набір даних перепису містить майже 700 000 окремих дерев. Однак ми завантажили лише крихітний зразок, оскільки API за замовчуванням має обмеження в 1000 рядків. Мені не хочеться отримати доступ до повного набору даних тут, оскільки я просто хочу проілюструвати деякі основні поняття. Тим не менш, якби ви <a href="https://dev.socrata.com/docs/queries/limit.html">прочитали документацію</a>, ви б побачили, що ви можете змінити це значення за умовчанням, додавши <code>?$limit= LIMIT</code> до кінцевої точки API. Наприклад, щоб прочитати лише перші п’ять рядків, ви можете використати:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Not run</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fromJSON</span>(<span class="st">"https://data.cityofnewyork.us/resource/uvpi-gqnh.json?$limit=5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Повертаючись до правильного шляху, давайте побудуємо дані нашого дерева. Одна незначна річ, на яку я хочу звернути увагу, це те, що <code>jsonlite::fromJSON()</code> автоматично перетворює все в текст, тому нам також потрібно буде перетворити деякі стовпці на числові перед початком візуалізації.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>nyc_trees <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(longitude, latitude, stump_diam, spc_common, spc_latin, tree_id) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(longitude<span class="sc">:</span>stump_diam), as.numeric) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>longitude, <span class="at">y=</span>latitude, <span class="at">size=</span>stump_diam)) <span class="sc">+</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">name =</span> <span class="st">"Stump diameter"</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Longitude"</span>, <span class="at">y =</span> <span class="st">"Latitude"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Sample of New York City trees"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: NYC Open Data"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06-web-api_files/figure-html/nyc3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Не погано. Це, напевно, було б веселішим/вражаючим із справжньою картою Нью-Йорка за ним. Однак ми збережемо це для наступної лекції…</p>
<p>Ще раз хочу нагадати вам, що наша перша спроба не вимагала попередньої реєстрації на веб-сайті Open Data NYC або створення ключа API. Це нетипово. Більшість інтерфейсів API дозволять отримати доступ до даних і завантажити їх лише після того, як ви зареєструєте в них ключ API. Це особливо вірно, якщо ви хочете отримати доступ до API, пов’язаного з державним агентством чи установою. Отже, давайте попрацюємо з програмою, де потрібен ключ API…</p>
</section>
<section id="застосування-2-fred-data" class="level1">
<h1>Застосування 2: FRED data</h1>
<p>Наша друга програма включатиме завантаження даних із <a href="https://research.stlouisfed.org/docs/api/fred/"><strong>FRED API</strong></a>. Вам потрібно буде <a href="https://research.stlouisfed.org/useraccount/apikey">зареєструвати ключ API</a>, якщо ви хочете виконати мої кроки, тож зробіть це, перш ніж продовжувати.</p>
<p><a href="https://fred.stlouisfed.org/">FRED</a> — це база даних, яку підтримує Федеральний резервний банк Сент-Луїса, який дає змогу будувати круті інтерактивні діаграми <a href="https://fred.stlouisfed.org/series/GNPCA#0">як цю</a> ВНП США з 1929 року.</p>
<iframe src="https://fred.stlouisfed.org/graph/graph-landing.php?g=yo2J&amp;width=670&amp;height=475" scrolling="no" frameborder="0" style="overflow:hidden; width:670px; height:525px;" allowtransparency="true" loading="lazy" data-external="1">
</iframe>
<p><br></p>
<p>Для цього другого прикладу програми я покажу вам, як завантажити дані, що лежать в основі діаграми вище, за допомогою FRED API. Насправді я піду глибше. Спочатку я покажу вам, як завантажити його самостійно, щоб ви могли зрозуміти, що відбувається під капотом. Потім я скерую вас до пакета, який виконує всю роботу API за вас.</p>
<section id="своїми-руками" class="level2">
<h2 class="anchored" data-anchor-id="своїми-руками">Своїми руками</h2>
<p>Як і з усіма API, хорошим місцем для початку є <a href="https://research.stlouisfed.org/docs/api/fred/">документація FRED API для розробників</a>. Якщо ви прочитаєте її, то побачите, що шлях кінцевої точки, який нас цікавить, це <a href="https://research.stlouisfed.org/docs/api/fred/series_observations.html"><strong>series/observations</strong></a>. Ця кінцева точка «отримує спостереження або значення даних для ряду економічних даних». Документація кінцевої точки містить більш глибоке обговорення, включаючи різноманітні параметри, які вона приймає<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Однак параметри, на яких ми зосередимося тут, це просто:</p>
<ul>
<li><strong>file_type:</strong> “json” (Необов’язково, але наш бажаний тип виведення.)</li>
<li><strong>series_id:</strong> “GNPCA” (обов’язково. Потрібний ряд даних.)</li>
<li><strong>api_key:</strong> “YOUR_API_KEY” (Обов’язково. Перейдіть і заберіть/скопіюйте свій ключ зараз.)</li>
</ul>
<p>Давайте об’єднаємо ці параметри зі шляхом кінцевої точки, щоб переглядати дані безпосередньо в нашому браузері. Перейдіть до <a href="https://api.stlouisfed.org/fred/series/observations?series_id=GNPCA&amp;api_key=%3Cmark%3EYOUR_API_KEY%3C/mark%3E&amp;file_type=json">https://api.stlouisfed.org/fred/series/observations?series_id=GNPCA&amp;api_key=<mark>YOUR_API_KEY</mark>&amp;file_type=json</a>, замінивши “YOUR_API_KEY” на ваш справжній ключ. Ви повинні побачити щось на зразок наступного:</p>
<p><img src="pics/fred-redacted.png" class="img-fluid"></p>
<p>У цей момент у вас, ймовірно, виникає спокуса прочитати об’єкт JSON безпосередньо у вашому середовищі R за допомогою функції <code>jsonlite::readJSON()</code>. І це спрацює. Однак це не те, до чого ми тут підемо. Натомість ми переглянемо пакет <code>httr</code> (<a href="https://httr.r-lib.org/">посилання</a>). чому? Ну, в основному тому, що <code>httr</code> поставляється з різноманітними функціями, які дозволяють нам більш гнучко та безпечно взаємодіяти з веб-API.</p>
<p>Давайте почнемо з визначення деяких зручних змінних, таких як шлях кінцевої точки та параметри (які ми будемо зберігати в списку).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>endpoint <span class="ot">=</span> <span class="st">"series/observations"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">api_key=</span> <span class="st">"YOUR_FRED_KEY"</span>, <span class="do">## Змініть на власний ключ</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_type=</span><span class="st">"json"</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id=</span><span class="st">"GNPCA"</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Далі ми використаємо функцію <code>httr::GET()</code> для запиту (тобто завантаження) даних. Я призначаю це об’єкту під назвою <code>fred</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>fred <span class="ot">=</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  httr<span class="sc">::</span><span class="fu">GET</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="st">"https://api.stlouisfed.org/"</span>, <span class="do">## Базовий URL</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="fu">paste0</span>(<span class="st">"fred/"</span>, endpoint),    <span class="do">## Кінцева точка API</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">query =</span> params                       <span class="do">## Наш список параметрів</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Витратьте секунду, щоб надрукувати об’єкт <code>fred</code> у вашій консолі. Те, що ви побачите, дуже круте; тобто це фактична відповідь API, включаючи <em>Status Code</em> та <em>Content</em>. Щось на зразок:</p>
<pre><code>## Response [https://api.stlouisfed.org/fred/series/observations?api_key=YOUR_FRED_KEY&amp;file_type=json&amp;series_id=GNPCA]
##   Date: 2023-04-30 20:54
##  Status: 400
##  Content-Type: application/json; charset=UTF-8
##  Size: 219 B</code></pre>
<p>Щоб фактично отримати вміст (тобто дані) з цієї відповіді, я скористаюся функцією <code>httr::content()</code>. Крім того, оскільки ми знаємо, що цей вміст є масивом JSON, ми можемо знову перетворити його на об’єкт R за допомогою <code>jsonlite::fromJSON()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fred <span class="ot">=</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  fred <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  httr<span class="sc">::</span><span class="fu">content</span>(<span class="st">"text"</span>) <span class="sc">%&gt;%</span> <span class="do">## Витягніть вміст відповіді (тобто текст)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>()      <span class="do">## Перетворення з JSON на об’єкт R</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Який тип об’єкта ми отримали?</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(fred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
</div>
<p>Виявляється, попередній крок дав об’єкт списку в R<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. тому тепер нам потрібно перевірити цей список, щоб краще зрозуміти його структуру, перш ніж витягувати інформацію, яка нас цікавить. Я б використав базову функцію <code>View()</code>, щоб зробити це в інтерактивному сеансі R. Але це не спрацює також для цих конспектів лекцій. Натомість я скористаюся функцією <code>listviewer::jsonedit()</code>, щоб створити інтерактивний віджет, який чудово відображається у Quarto.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View(fred) ## Що я б використав в інтерактивному сеансі R</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(listviewer)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">jsonedit</span>(fred, <span class="at">mode =</span> <span class="st">"view"</span>) <span class="do">## Краще для документів Quarto.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="jsonedit html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-fc79677607f728ab66b6" style="width:100%;height:10%;"></div>
<script type="application/json" data-for="htmlwidget-fc79677607f728ab66b6">{"x":{"data":{"realtime_start":"2023-04-30","realtime_end":"2023-04-30","observation_start":"1600-01-01","observation_end":"9999-12-31","units":"lin","output_type":1,"file_type":"json","order_by":"observation_date","sort_order":"asc","count":94,"offset":0,"limit":100000,"observations":{"realtime_start":["2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30"],"realtime_end":["2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30","2023-04-30"],"date":["1929-01-01","1930-01-01","1931-01-01","1932-01-01","1933-01-01","1934-01-01","1935-01-01","1936-01-01","1937-01-01","1938-01-01","1939-01-01","1940-01-01","1941-01-01","1942-01-01","1943-01-01","1944-01-01","1945-01-01","1946-01-01","1947-01-01","1948-01-01","1949-01-01","1950-01-01","1951-01-01","1952-01-01","1953-01-01","1954-01-01","1955-01-01","1956-01-01","1957-01-01","1958-01-01","1959-01-01","1960-01-01","1961-01-01","1962-01-01","1963-01-01","1964-01-01","1965-01-01","1966-01-01","1967-01-01","1968-01-01","1969-01-01","1970-01-01","1971-01-01","1972-01-01","1973-01-01","1974-01-01","1975-01-01","1976-01-01","1977-01-01","1978-01-01","1979-01-01","1980-01-01","1981-01-01","1982-01-01","1983-01-01","1984-01-01","1985-01-01","1986-01-01","1987-01-01","1988-01-01","1989-01-01","1990-01-01","1991-01-01","1992-01-01","1993-01-01","1994-01-01","1995-01-01","1996-01-01","1997-01-01","1998-01-01","1999-01-01","2000-01-01","2001-01-01","2002-01-01","2003-01-01","2004-01-01","2005-01-01","2006-01-01","2007-01-01","2008-01-01","2009-01-01","2010-01-01","2011-01-01","2012-01-01","2013-01-01","2014-01-01","2015-01-01","2016-01-01","2017-01-01","2018-01-01","2019-01-01","2020-01-01","2021-01-01","2022-01-01"],"value":["1120.718","1025.678","958.927","834.769","823.628","911.541","993.105","1119.585","1178.246","1139.642","1230.925","1337.841","1575.642","1871.983","2189.071","2362.975","2338.969","2070.151","2049.467","2135.513","2122.417","2306.989","2494.576","2596.421","2716.622","2702.089","2895.628","2958.791","3021.813","2996.399","3203.383","3287.198","3373.14","3581.347","3738.045","3954.0","4210.314","4483.972","4607.057","4834.326","4983.311","4992.183","5159.148","5431.25","5749.44","5726.106","5700.701","6014.406","6296.866","6641.362","6871.738","6853.455","7014.945","6893.027","7203.261","7715.155","8011.781","8270.745","8553.636","8916.983","9244.062","9430.025","9411.632","9739.841","10006.004","10395.034","10678.341","11082.604","11562.713","12070.819","12664.858","13188.215","13327.597","13546.065","13937.444","14491.356","14987.679","15368.242","15727.504","15796.274","15395.345","15863.425","16133.673","16486.727","16780.258","17159.215","17602.487","17901.894","18350.745","18874.78","19286.841","18685.401","19759.327","20158.225"]}},"options":{"mode":"view","modes":["code","form","text","tree","view"]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>На щастя, цей конкретний об’єкт списку не надто складний. Ми бачимо, що насправді нас цікавить піделемент <code>fred$observations</code>. Я використаю <code>purrr::pluck()</code>, щоб дістати цей елемент (є багато інших способів зробити це), а потім перетворимо його на тібл.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fred <span class="ot">=</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  fred <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">"observations"</span>) <span class="sc">%&gt;%</span> <span class="do">## Витягніть елемент списку "$observations".</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># .$observations %&gt;% ## Я також міг би скористатися цим</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># magrittr::extract("observations") %&gt;% ## Або цим</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>fred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 94 × 4
   realtime_start realtime_end date       value   
   &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;   
 1 2023-04-30     2023-04-30   1929-01-01 1120.718
 2 2023-04-30     2023-04-30   1930-01-01 1025.678
 3 2023-04-30     2023-04-30   1931-01-01 958.927 
 4 2023-04-30     2023-04-30   1932-01-01 834.769 
 5 2023-04-30     2023-04-30   1933-01-01 823.628 
 6 2023-04-30     2023-04-30   1934-01-01 911.541 
 7 2023-04-30     2023-04-30   1935-01-01 993.105 
 8 2023-04-30     2023-04-30   1936-01-01 1119.585
 9 2023-04-30     2023-04-30   1937-01-01 1178.246
10 2023-04-30     2023-04-30   1938-01-01 1139.642
# ℹ 84 more rows</code></pre>
</div>
</div>
<p>Гаразд! Нарешті ми отримали наші дані та майже готові до побудови. Пам’ятайте, що <code>jsonlite::fromJSON()</code> автоматично перетворює все на текст, тому я швидко зміню деякі змінні на дати (за допомогою <code>lubridate::ymd()</code>) і числа.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>fred <span class="ot">=</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  fred <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(realtime_start<span class="sc">:</span>date, ymd)) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">as.numeric</span>(value)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Давайте візуалізуємо…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fred <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, value)) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="st">"Date"</span>, <span class="at">y=</span><span class="st">"2023 USD (Billions)"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">"US Real Gross National Product"</span>, <span class="at">caption=</span><span class="st">"Source: FRED"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06-web-api_files/figure-html/fred6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="крім-того-безпечно-зберігайте-та-використовуйте-ключі-api-як-змінні-середовища" class="level2">
<h2 class="anchored" data-anchor-id="крім-того-безпечно-зберігайте-та-використовуйте-ключі-api-як-змінні-середовища">Крім того: безпечно зберігайте та використовуйте ключі API як змінні середовища</h2>
<p>У наведеному вище прикладі я припустив, що ви просто заміните текст власника “YOUR_FRED_KEY” на ваш фактичний ключ API. Це, очевидно, не дуже безпечно чи масштабовано, оскільки це означає, що ви не можете поділитися своїм сценарієм R, не передавши свій ключ<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. На щастя, є простий спосіб щоб безпечно зберігати та використовувати конфіденційну інформацію, наприклад ключі API або паролі: просто збережіть їх як R <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/%20html/EnvVar.html"><strong>змінні середовища</strong></a>. Існує два тісно пов’язані підходи:</p>
<ol type="1">
<li>Встановіть змінну середовища лише для поточного сеансу R.</li>
<li>Встановіть змінну середовища, яка зберігається протягом сеансів R.</li>
</ol>
<p>Давайте коротко розглянемо кожен по черзі.</p>
<section id="встановіть-змінну-середовища-лише-для-поточного-сеансу-r" class="level3">
<h3 class="anchored" data-anchor-id="встановіть-змінну-середовища-лише-для-поточного-сеансу-r">1) Встановіть змінну середовища лише для поточного сеансу R</h3>
<p>Визначити змінну середовища для поточного сеансу R дуже просто. Просто використовуйте базову функцію <code>Sys.setenv()</code>. Наприклад:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Установіть нову змінну середовища під назвою MY_API_KEY. Лише поточний сеанс.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">MY_API_KEY=</span><span class="st">"abcdefghijklmnopqrstuvwxyz0123456789"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Коли це буде зроблено, ви можете безпечно призначити свій ключ об’єкту — включно з документом Quarto, який ви збираєтеся зібрати та поділитися — за допомогою функції <code>Sys.getenv()</code>. Наприклад:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Призначте змінну середовища об’єкту R</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>my_api_key <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">"MY_API_KEY"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## роздрукуйте його, щоб показати, що він працює</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>my_api_key</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "abcdefghijklmnopqrstuvwxyz0123456789"</code></pre>
</div>
</div>
<p><strong>Важливо:</strong> хоча цей підхід дуже простий, зауважте, що на практиці частину <code>Sys.setenv()</code> слід запускати лише безпосередньо у вашій консолі R. <em>Ніколи</em> не включайте фрагменти коду з конфіденційними викликами <code>Sys.setenv()</code> у файл Quarto або інші спільні документи<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. Це повністю зруйнувало б мету! Крім роздратування необхідності вручну встановлювати мій ключ API кожного разу, коли я запускаю новий сеанс R, це одна з причин, чому я віддаю перевагу наступному підходу збереження змінних середовища в сесіях…</p>
</section>
<section id="встановіть-змінну-середовища-яка-зберігається-протягом-сеансів-r" class="level3">
<h3 class="anchored" data-anchor-id="встановіть-змінну-середовища-яка-зберігається-протягом-сеансів-r">2) Встановіть змінну середовища, яка зберігається протягом сеансів R</h3>
<p>Трюк для встановлення змінної середовища R, доступної для всіх сеансів, полягає в тому, щоб додати її до спеціального файлу під назвою <code>~/.Renviron</code>. Це текстовий файл, який знаходиться у вашому домашньому каталозі — зверніть увагу на шлях <code>~/</code> — який R автоматично зчитує під час запуску. Оскільки <code>~/.Renviron</code> — це лише текстовий файл, ви можете редагувати його будь-яким текстовим редактором, який вам подобається. Однак вам може знадобитися спочатку створити його, якщо він не існує. Зручним способом зробити все це з RStudio є функція <code>usethis::edit_r_environ()</code>. Вам потрібно буде запустити наступні кілька рядків в інтерактивному режимі:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Відкрийте файл .Renviron. Тут ми можемо додати ключі API, які зберігаються протягом сеансів R.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">edit_r_environ</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Це відкриє ваш файл <code>~/.Renviron</code> у новому вікні RStudio, який ви зможете змінити за потреби. Як приклад, припустімо, що ви хочете додати свій ключ API FRED як змінну середовища, яка зберігається протягом сеансів. Ви можете зробити це, просто додавши рядок, подібний до наведеного нижче, до вашого файлу <code>~/.Renviron</code> і збережіть його.</p>
<pre><code>FRED_API_KEY="abcdefghijklmnopqrstuvwxyz0123456789" ## Замініть справжнім ключем</code></pre>
<p>Після того, як ви збережете зміни, вам потрібно буде перезавантажити R, щоб ця нова змінна середовища була доступна в поточному сеансі.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">readRenviron</span>(<span class="st">"~/.Renviron"</span>) <span class="do">## Необхідно, лише якщо ви читаєте в щойно доданій змінній середовища R</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Завдання:</strong> Після оновлення файлу <code>~/.Renviron</code> спробуйте повторно завантажити дані FRED, отримані раніше. Цього разу викличте свій ключ FRED API безпосередньо як змінну середовища у списку параметрів за допомогою <code>Sys.getenv()</code> ось так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">api_key=</span> <span class="fu">Sys.getenv</span>(<span class="st">"FRED_API_KEY"</span>), <span class="do">## Отримайте API безпосередньо та безпечно зі збереженої змінної середовища</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_type=</span><span class="st">"json"</span>, </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id=</span><span class="st">"GNPCA"</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="за-допомогою-пакету" class="level2">
<h2 class="anchored" data-anchor-id="за-допомогою-пакету">За допомогою пакету</h2>
<p>Однією з чудових особливостей R (і спільноти наукових даних загалом) є те, що хтось, ймовірно, написав пакет, який виконує всю важку роботу API за вас. Протягом решти курсу ми зустрінемо багато прикладів, але наразі я хочу позначити пакет <strong>fredr</strong> (<a href="http://sboysel.github.io/fredr/index.html">посилання</a> ). Подивіться на сторінку «Get started», щоб побачити, як ви можете отримати доступ до тих самих даних ВВП, що й вище, але цього разу через пакет.</p>
</section>
</section>
<section id="застосування-3-світовий-рейтинг-з-регбі" class="level1">
<h1>Застосування 3: Світовий рейтинг з регбі</h1>
<p>Наша остаточна заявка включатиме більш складний випадок, коли кінцева точка API <em>прихована від очей</em>. Зокрема, я покажу вам, як отримати доступ до даних <a href="https://www.world.rugby/tournaments/rankings/mru"><strong>Світового рейтингу з регбі</strong></a>.</p>
<p>Почніть із перегляду складної структури веб-сайту в <a href="https://www.world.rugby/tournaments/rankings/mru">живому сеансі</a>. Зверніть увагу на різні таблиці та інші інтерактивні елементи, такі як календарі. Тепер приділіть хвилину або дві для швидкого завдання: спробуйте отримати повний рейтинг країни за допомогою підходу <code>rvest</code> + селектори CSS, який ми практикували минулого разу…</p>
<p>Якщо ви схожі на мене, вам було б важко отримати потрібну інформацію за допомогою підходу <code>rvest</code> + селектори CSS. Навіть якщо вам вдалося отримати якусь інформацію, ви, швидше за все, отримаєте лише частину того, що хотіли. (Наприклад, лише назви стовпців або перші десять рядків перед кнопкою «ПЕРЕГЛЯНУТИ ІНШІ РЕЙТИНГИ»). І ми навіть не розглядали спробу отримати інформацію з іншої дати<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<section id="пошук-прихованої-кінцевої-точки-api" class="level2">
<h2 class="anchored" data-anchor-id="пошук-прихованої-кінцевої-точки-api">Пошук прихованої кінцевої точки API</h2>
<p>На щастя, є кращий спосіб: отримати доступ до повної бази даних рейтингів через API. Однак спочатку ми повинні знайти кінцеву точку. Ось покрокова інструкція, як це зробити. Це досить стомлююче, але досить інтуїтивно зрозуміле, коли ви зрозумієте.</p>
<ul>
<li>Почніть з огляду сторінки. (<strong>Ctr+Shift+I</strong> у Chrome. <strong>Ctrl+Shift+Q</strong> у Firefox.)</li>
<li>Перейдіть на вкладку <strong>Network</strong> у верхній частині панелі перевірки елементів.</li>
<li>Натисніть кнопку <strong>XHR</strong><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</li>
<li>Оновіть сторінку (<strong>Ctrl+R</strong>). Це дозволить нам бачити весь веб-трафік, що надходить до сторінки та зі сторінки на нашій панелі перевірки.</li>
<li>Зараз наше завдання полягає в тому, щоб прокрутити ці різні посилання на трафік і побачити, яке з них містить інформацію, яку ми шукаємо.</li>
<li>Найпопулярніший елемент посилання на трафік посилається на URL-адресу під назвою <a href="https://cmsapi.pulselive.com/rugby/rankings/mru?language=en">https://cmsapi.pulselive.com/rugby/<b>rankings</b>/mru?language=en</a>. <em>Хммм. “API”, ви кажете? Ви кажете “рейтинги”? Звучить багатообіцяюче…</em></li>
<li>Натисніть на цей елемент і відкрийте вкладку <strong>Preview</strong>.</li>
<li>У цьому випадку ми можемо побачити, що виглядає як перший рядок рейтингової таблиці (“Ірландія” тощо)</li>
<li>Щоб переконатися, ви можете отримати <a href="URL">https://cmsapi.pulselive.com/rugby/rankings/mru?language=en</a> і вставити його в наш браузер (за допомогою <a href="https://chrome.google.com/webstore/detail/jsonvue/chklaanhfefbnpoihckbnefhakgolnmc?hl=en">JSONView</a>).</li>
</ul>
<p>Круто. Схоже, ми знайшли нашу кінцеву точку API.</p>
</section>
<section id="передаємо-дані-у-r" class="level2">
<h2 class="anchored" data-anchor-id="передаємо-дані-у-r">Передаємо дані у R</h2>
<p>Давайте перетягнемо дані з кінцевої точки API в R. Знову ж таки, я буду використовувати функцію <code>jsonlite::readJSON()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>endpoint <span class="ot">=</span> <span class="st">"https://cmsapi.pulselive.com/rugby/rankings/mru?language=en"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>rugby <span class="ot">=</span> <span class="fu">fromJSON</span>(endpoint)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(rugby)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ label    : chr "Mens Rugby Union"
 $ entries  :'data.frame':  109 obs. of  6 variables:
  ..$ team       :'data.frame': 109 obs. of  5 variables:
  .. ..$ id          : int [1:109] 36 42 37 39 35 34 38 40 33 49 ...
  .. ..$ altId       : logi [1:109] NA NA NA NA NA NA ...
  .. ..$ name        : chr [1:109] "Ireland" "France" "New Zealand" "South Africa" ...
  .. ..$ abbreviation: chr [1:109] "IRE" "FRA" "NZL" "RSA" ...
  .. ..$ annotations : logi [1:109] NA NA NA NA NA NA ...
  ..$ matches    : int [1:109] 231 234 254 235 225 240 261 214 251 186 ...
  ..$ pts        : num [1:109] 91.8 90.5 89 89 82.8 ...
  ..$ pos        : int [1:109] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ previousPts: num [1:109] 91.8 90.5 89 89 82.8 ...
  ..$ previousPos: int [1:109] 1 2 3 4 5 6 7 8 9 10 ...
 $ effective:List of 3
  ..$ millis   : num 1.68e+12
  ..$ gmtOffset: num 0
  ..$ label    : chr "2023-04-24"</code></pre>
</div>
</div>
<p>У нас є вкладений список, де те, що здається головним цікавим елементом, <code>$entries</code>, саме по собі є списком<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>. Давайте витягнемо елемент <code>$entries</code> і подивимося на його структуру. Знову ж таки, я б просто використав базову базу <code>View()</code> в інтерактивному сеансі R. Тут я використовую <code>listviewer::jsonedit()</code>, оскільки він чудово працює з документами Quarto.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># str(rugby$entries) ## Базовий варіант</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>listviewer<span class="sc">::</span><span class="fu">jsonedit</span>(rugby, <span class="at">mode =</span> <span class="st">"view"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="jsonedit html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-3a09131a8fa40c3b2423" style="width:100%;height:10%;"></div>
<script type="application/json" data-for="htmlwidget-3a09131a8fa40c3b2423">{"x":{"data":{"label":"Mens Rugby Union","entries":{"team":{"id":[36,42,37,39,35,34,38,40,33,49,720,45,46,41,47,44,68,51,52,43,58,708,50,725,756,64,770,703,699,736,57,721,735,753,714,777,711,775,769,751,2537,713,776,740,1030,766,745,681,741,1247,774,738,712,707,760,759,743,723,704,729,3223,739,734,737,710,726,732,700,784,1031,1029,722,752,3200,702,715,781,772,761,2340,2476,709,698,750,727,2382,696,701,692,2861,2389,2397,2857,2744,1784,2387,2585,748,697,749,2386,768,762,705,2576,744,2529,780,3674],"altId":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],"name":["Ireland","France","New Zealand","South Africa","Scotland","England","Australia","Argentina","Wales","Japan","Georgia","Samoa","Fiji","Italy","Tonga","Portugal","Uruguay","USA","Romania","Spain","Namibia","Chile","Canada","Hong Kong China","Russia","Netherlands","Switzerland","Brazil","Belgium","Korea","Zimbabwe","Germany","Kenya","Poland","Czechia","Ukraine","Colombia","Tunisia","Sweden","Paraguay","Philippines","Croatia","Uganda","Madagascar","Malta","Sri Lanka","Morocco","Cote D'Ivoire","Malaysia","Mexico","Trinidad & Tobago","Lithuania","Cook Islands","Cayman Islands","Singapore","Senegal","Moldova","Guyana","Bulgaria","Israel","United Arab Emirates","Luxembourg","Kazakhstan","Latvia","Chinese Taipei","Hungary","Jamaica","Bermuda","Zambia","Nigeria","Finland","Guam","Peru","Algeria","Botswana","Denmark","Venezuela","Thailand","Slovenia","Serbia","St Vincent and Grenadines","China","Barbados","Papua New Guinea","India","Ghana","Austria","Bosnia & Herzegovina","Andorra","Uzbekistan","Burkina Faso","Pakistan","Mauritius","Iran","Laos","Rwanda","Costa Rica","Niue Island","Bahamas","Norway","Burundi","Eswatini","Solomon Islands","Cameroon","Indonesia","Monaco","Greece","Vanuatu","American Samoa"],"abbreviation":["IRE","FRA","NZL","RSA","SCO","ENG","AUS","ARG","WAL","JPN","GEO","SAM","FIJ","ITA","TGA","POR","URU","USA","ROU","ESP","NAM","CHI","CAN","HKG","RUS","NED","SUI","BRA","BEL","KOR","ZIM","GER","KEN","POL","CZE","UKR","COL","TUN","SWE","PAR","PHI","CRO","UGA","MAD","MLT","SRI","MAR","CIV","MAS","MEX","TTO","LTU","COK","CAY","SGP","SEN","MDA","GUY","BUL","ISR","UAE","LUX","KAZ","LAT","TPE","HUN","JAM","BER","ZAM","NGR","FIN","GUM","PER","ALG","BOT","DEN","VEN","THA","SLO","SRB","VIN","CHN","BAR","PNG","IND","GHA","AUT","BIH","AND","UZB","BUR","PAK","MRI","IRI","LAO","RWA","CRC","NIU","BAH","NOR","BDI","SWZ","SOL","CMR","INA","MON","GRE","VAN","ASA"],"annotations":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]},"matches":[231,234,254,235,225,240,261,214,251,186,194,126,129,223,121,167,153,143,188,151,116,100,151,113,164,109,84,108,112,73,86,120,110,97,97,96,62,58,90,68,33,83,86,51,82,57,50,57,53,35,36,87,28,40,49,53,85,38,64,75,28,74,58,78,48,78,28,38,50,26,64,24,49,15,40,83,49,52,76,69,14,38,38,35,37,18,74,61,73,8,17,17,23,10,10,14,11,21,27,73,12,19,25,27,5,12,17,18,13],"pts":[91.82172,90.469124,88.97597,88.96918,82.76553,82.11643,81.80232,80.71754,78.077896,77.39377,76.23303,76.025955,74.84451,74.63309,71.20638,67.61918,66.244865,65.92085,65.850845,64.04897,61.59889,60.88881,60.45703,59.657158,58.06119,55.835484,55.723118,55.23177,54.58191,52.621853,52.432995,52.319912,51.79317,51.543404,50.259144,49.302677,48.686245,48.54903,48.307404,48.135277,47.795654,47.513203,47.25068,46.89262,46.751057,46.72597,46.33345,46.238205,46.117237,45.821316,45.509857,45.388496,45.106884,44.368988,44.045013,43.21601,43.03965,42.862232,42.400764,41.235992,41.232292,41.080105,40.910267,40.73034,39.229748,39.105125,39.00289,38.911465,38.826706,38.371357,36.58898,36.378345,36.34963,36.252018,36.21395,36.104248,35.872917,35.485294,35.435627,35.202515,34.914616,34.91419,34.724777,33.683735,33.39797,33.26817,33.03452,31.933296,31.81891,31.2828,31.05,30.78201,30.5581,30,30,29.783758,29.355816,28.626186,27.756924,26.52429,26.156487,26.041035,23.97296,23.120085,21.948198,17.171558,16.546452,15.289167,13.532106],"pos":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,94,96,97,98,99,100,101,102,103,104,105,106,107,108,109],"previousPts":[91.82172,90.469124,88.97597,88.96918,82.76553,82.11643,81.80232,80.71754,78.077896,77.39377,76.23303,76.025955,74.84451,74.63309,71.20638,67.61918,66.244865,65.92085,65.850845,64.04897,61.59889,60.88881,60.45703,59.657158,58.06119,55.835484,55.723118,55.23177,54.58191,52.621853,52.432995,52.319912,51.79317,51.543404,50.259144,49.302677,48.686245,48.54903,48.307404,48.135277,47.795654,47.513203,47.25068,46.89262,46.751057,46.72597,46.33345,46.238205,46.117237,45.821316,45.509857,45.388496,45.106884,44.368988,44.045013,43.21601,43.03965,42.862232,42.400764,40.978928,41.232292,41.080105,40.910267,40.73034,39.229748,39.105125,39.00289,38.911465,38.826706,38.371357,35.56024,36.378345,36.34963,36.252018,36.21395,36.104248,35.872917,35.485294,35.69269,35.202515,34.914616,34.91419,34.724777,33.683735,33.39797,33.26817,33.03452,31.933296,32.847652,31.2828,31.05,30.78201,30.5581,30,30,29.783758,29.355816,28.626186,27.756924,26.52429,26.156487,26.041035,23.97296,23.120085,21.948198,17.171558,16.546452,15.289167,13.532106],"previousPos":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,62,60,61,63,64,65,66,67,68,69,70,78,71,72,73,74,75,76,79,77,80,81,82,83,84,85,86,87,89,88,90,91,92,93,94,94,96,97,98,99,100,101,102,103,104,105,106,107,108,109]},"effective":{"millis":1682294400000,"gmtOffset":0,"label":"2023-04-24"}},"options":{"mode":"view","modes":["code","form","text","tree","view"]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Для повноти давайте розглянемо фрейм даних <code>rugby$entries$team</code>, щоб підтвердити, що він містить корисну для нас інформацію.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rugby<span class="sc">$</span>entries<span class="sc">$</span>team)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id altId         name abbreviation annotations
1 36    NA      Ireland          IRE          NA
2 42    NA       France          FRA          NA
3 37    NA  New Zealand          NZL          NA
4 39    NA South Africa          RSA          NA
5 35    NA     Scotland          SCO          NA
6 34    NA      England          ENG          NA</code></pre>
</div>
</div>
<p>Гаразд, картина починає вимальовуватися чіткіше. Здається, ми можемо просто прив’язати стовпці фрейму даних <code>rugby$entries$team</code> безпосередньо до інших елементів батьківського «фрейму даних» <code>$team</code> (насправді: «списку»). Давайте зробимо це за допомогою <code>dplyr::bind_cols()</code>, а потім трохи очистимо. Я буду називати отриманий кадр даних <code>rankings</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>rankings <span class="ot">=</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    rugby<span class="sc">$</span>entries<span class="sc">$</span>team,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    rugby<span class="sc">$</span>entries <span class="sc">%&gt;%</span> <span class="fu">select</span>(matches<span class="sc">:</span>previousPos)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(id, alt_id, annotations)) <span class="sc">%&gt;%</span> <span class="do">## Ці колонки не додають особливого інтересу</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pos, pts, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> <span class="do">## Змініть порядок решти стовпців</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>rankings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 109 × 7
     pos   pts name         abbreviation matches previous_pts previous_pos
   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;          &lt;int&gt;        &lt;dbl&gt;        &lt;int&gt;
 1     1  91.8 Ireland      IRE              231         91.8            1
 2     2  90.5 France       FRA              234         90.5            2
 3     3  89.0 New Zealand  NZL              254         89.0            3
 4     4  89.0 South Africa RSA              235         89.0            4
 5     5  82.8 Scotland     SCO              225         82.8            5
 6     6  82.1 England      ENG              240         82.1            6
 7     7  81.8 Australia    AUS              261         81.8            7
 8     8  80.7 Argentina    ARG              214         80.7            8
 9     9  78.1 Wales        WAL              251         78.1            9
10    10  77.4 Japan        JPN              186         77.4           10
# ℹ 99 more rows</code></pre>
</div>
</div>
</section>
<section id="бонус-отримуйте-та-створюйте-історію-рейтингів" class="level2">
<h2 class="anchored" data-anchor-id="бонус-отримуйте-та-створюйте-історію-рейтингів">БОНУС: отримуйте та створюйте історію рейтингів</h2>
<p><em>ПРИМІТКА: цей бонусний розділ включає певне програмування та цикли. Я знаю, що ми ще не дійшли до розділу курсу з програмування, тому не хвилюйтеся про особливості наступних кількох фрагментів коду. Я спробую прокоментувати свій код досить чітко, але я хочу, щоб ви зосередилися на загальній картині.</em></p>
<p>Таблиця вище виглядає чудово, за винятком того факту, що це лише один знімок останніх рейтингів. Мабуть, нам більше цікаво озирнутися на зміни в рейтингах з часом.</p>
<p>Але як це зробити? Що ж, давайте знову відкриємо вікно перевірки сторінки рейтингу та почнемо досліджувати. Що станеться, якщо ми натиснемо елемент календаря, скажімо, змінимо рік на «2022», а місяць на «жовтень»? (Зробіть це самі.)</p>
<p>Це виглядає багатообіцяюче! По суті, ми отримуємо ту саму кінцеву точку API, яку бачили раніше, але тепер до неї додано дату, https://cmsapi.pulselive.com/rugby/rankings/mru?language=en&amp;date=2022-01-10. Якби ви продовжили таким чином — клацали на календарі веб-сайту та шукали трафік XHR — ви б незабаром зрозуміли, що ці суфікси дат дотримуються передбачуваного шаблону: вони розташовуються на один тиждень і завжди потрапляють на понеділок. Іншими словами, World Rugby щотижня оновлює свою міжнародну таблицю рейтингів і публікує результати щопонеділка.</p>
<p>Тепер ми маємо достатньо інформації, щоб написати функцію, яка циклічно оброблятиме набір дат і отримуватиме дані з відповідної кінцевої точки API. Для початку нам потрібен вектор дійсних дат для циклу. Я збираюся використовувати різні функції з пакету <code>lubridate</code>, щоб допомогти з цим. Зауважте, що я маю лише витягти кілька точок даних — одне спостереження на рік протягом останнього десятиліття чи близько того — оскільки я хочу лише продемонструвати принцип. Немає необхідності забивати хост-сервер. (Докладніше про це нижче.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Ми переглядатимемо рейтинг приблизно 1 січня кожного року. Я буду використовувати 2004 як</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="do">## довільний початковий рік, а потім продовження до поточного року.</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">=</span> <span class="fu">ymd</span>(<span class="st">"2004-01-01"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">=</span> <span class="fu">floor_date</span>(<span class="fu">today</span>(), <span class="at">unit=</span><span class="st">"years"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">=</span> <span class="fu">seq</span>(start_date, end_date, <span class="at">by=</span><span class="st">"years"</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Отримайте найближчий понеділок до 1 січня, щоб збігтися з датами випуску рейтингу.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">=</span> <span class="fu">floor_date</span>(dates, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="fu">getOption</span>(<span class="st">"lubridate.week.start"</span>, <span class="dv">1</span>))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>dates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "2003-12-29" "2004-12-27" "2005-12-26" "2007-01-01" "2007-12-31"
 [6] "2008-12-29" "2009-12-28" "2010-12-27" "2011-12-26" "2012-12-31"
[11] "2013-12-30" "2014-12-29" "2015-12-28" "2016-12-26" "2018-01-01"
[16] "2018-12-31" "2019-12-30" "2020-12-28" "2021-12-27" "2022-12-26"</code></pre>
</div>
</div>
<p>Далі я напишу функцію, яку назву <code>rugby_scrape</code>. Ця функція прийматиме один аргумент: дату, яку вона використовуватиме для створення нової кінцевої точки API під час кожної ітерації. Крім того, він виконуватиме майже те ж саме, що ми робили в нашому попередньому ручному збиранні даних. Єдина відмінність полягає в тому, що він чекатиме три секунди після запуску (тобто <code>Sys.sleep(3)</code>). Я додаю цей останній рядок, щоб уникнути забиття сервера миттєвими запитами, коли ми вводимо все в цикл.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Спочатку видаліть наші існуючі змінні. Це зовсім не обов'язково, оскільки R досить розумний</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="do">## щоб відрізнити іменовані об’єкти у функціях від іменованих об’єктів у нашому глобальному середовищі.</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Але я хочу підкреслити, що ми створюємо тут нові дані, щоб уникнути плутанини.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(rugby, rankings, endpoint)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Now, create the function. I'll call it "rugby_scrape".</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>rugby_scrape <span class="ot">=</span> </span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    endpoint <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"https://cmsapi.pulselive.com/rugby/rankings/mru?language=en&amp;date="</span>, x)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    rugby <span class="ot">=</span> <span class="fu">fromJSON</span>(endpoint)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    rankings <span class="ot">=</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        rugby<span class="sc">$</span>entries<span class="sc">$</span>team,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        rugby<span class="sc">$</span>entries <span class="sc">%&gt;%</span> <span class="fu">select</span>(matches<span class="sc">:</span>previousPos)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">date =</span> x) <span class="sc">%&gt;%</span> <span class="do">## Нова колонка для відстеження дати</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(id, alt_id, annotations)) <span class="sc">%&gt;%</span> <span class="do">## Ці колонки не додають особливого інтересу</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(date, pos, pts, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> <span class="do">## Змініть порядок решти стовпців</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>()</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">3</span>) <span class="do">## Будь вихованим!</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(rankings)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Нарешті, тепер ми можемо виконувати ітерацію (тобто цикл) над нашим вектором <code>dates</code>, підключаючи значення послідовно до нашої функції <code>rugby_scrape</code>. Є багато способів ітерації в R, але я збираюся використовувати <code>lapply()</code><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>. Потім ми зв’яжемо все в один кадр даних за допомогою <code>dplyr::bind_rows()</code> і назвемо отриманий об’єкт <code>rankings_history</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>rankings_history <span class="ot">=</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(dates, rugby_scrape) <span class="sc">%&gt;%</span> <span class="do">## Запустіть ітерацію</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>() <span class="do">## Зв’яжіть отриманий фрейм в один дата фрейм</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>rankings_history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,997 × 8
   date         pos   pts name    abbreviation matches previous_pts previous_pos
   &lt;date&gt;     &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;int&gt;        &lt;dbl&gt;        &lt;int&gt;
 1 2003-12-29     1  94.0 England ENG               17         92.1            1
 2 2003-12-29     2  90.1 New Ze… NZL               17         88.2            3
 3 2003-12-29     3  86.6 Austra… AUS               17         88.4            2
 4 2003-12-29     4  82.7 France  FRA               17         84.7            4
 5 2003-12-29     5  81.2 South … RSA               15         81.2            5
 6 2003-12-29     6  80.5 Ireland IRE               15         80.5            6
 7 2003-12-29     7  78.0 Argent… ARG               14         78.0            7
 8 2003-12-29     8  76.9 Wales   WAL               15         76.9            8
 9 2003-12-29     9  76.4 Scotla… SCO               15         76.4            9
10 2003-12-29    10  73.5 Samoa   SAM               14         73.5           10
# ℹ 1,987 more rows</code></pre>
</div>
</div>
<p>Давайте переглянемо, що ми щойно зробили:</p>
<ul>
<li>Ми створили вектор дат — творчо названих <code>dates</code> — з рівномірним інтервалом (приблизно) рік, припадаючи на понеділок, найближчий до 1 січня цього року.</li>
<li>Потім ми повторили (тобто зациклили) ці дати за допомогою функції <code>rugby_scrape</code>, яка завантажувала та очищала дані з відповідної кінцевої точки API.</li>
<li>Наприкінці кожної ітерації ми говорили R зачекати кілька секунд перед виконанням наступного кроку. Пам’ятайте, що R може виконувати ці кроки набагато, набагато швидше, ніж ми коли-небудь могли б ввести їх вручну. Можливо, для цього прикладу це не має значення, але ви можете легко «перевантажити» хост-сервер, задавивши його циклом автоматизованих запитів. (Або, не менш імовірно: у них є запобіжні заходи проти такого типу поведінки, і вони почнуть відхиляти ваші запити як підозрювану зловмисну атаку.) Як завжди, девіз «будь чемним» залишається в силі під час збирання веб-даних.</li>
<li>Зауважте, що кожен запуск нашої ітерації створюватиме окремий кадр даних, який <code>lapply()</code> за замовчуванням додає до списку. Ми використовували <code>dplyr::bind_rows()</code>, щоб об’єднати ці окремі кадри даних в один кадр даних.</li>
</ul>
<p>Гаразд! Давайте побудуємо дані та виділимо кілька обраних країн у процесі.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>teams <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NZL"</span>, <span class="st">"IRE"</span>, <span class="st">"ENG"</span>, <span class="st">"JPN"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>team_cols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NZL"</span><span class="ot">=</span><span class="st">"black"</span>, <span class="st">"IRE"</span><span class="ot">=</span><span class="st">"#4DAF4A"</span>, <span class="st">"ENG"</span><span class="ot">=</span><span class="st">"#377EB8"</span>, <span class="st">"JPN"</span> <span class="ot">=</span> <span class="st">"red"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>rankings_history <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>date, <span class="at">y=</span>pts, <span class="at">group=</span>abbreviation)) <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">"grey"</span>) <span class="sc">+</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> rankings_history <span class="sc">%&gt;%</span> <span class="fu">filter</span>(abbreviation <span class="sc">%in%</span> teams), </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">col=</span><span class="fu">fct_reorder2</span>(abbreviation, date, pts)),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> team_cols) <span class="sc">+</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Points"</span>, </span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"International rugby rankings"</span>, <span class="at">caption =</span> <span class="st">"Source: World Rugby"</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="06-web-api_files/figure-html/rugby7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Домінування Нової Зеландії у грі є надзвичайним, особливо з огляду на крихітну чисельність її населення. Вони справді мають законне право бути <a href="https://www.dailytelegraph.com.au/sport/rugby/are-the-all-blacks-the-greatest-international-team-in-%20the-history-of-sport/news-story/f61ad2d65623a9586929bbfba386b157">найкращою міжнародною командою</a> в історії професійного спорту.</p>
<div class="quarto-video ratio ratio-16x9"><iframe src="https://www.youtube.com/embed/yiKFYTFJ_kw" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
</section>
<section id="додаткові-ресурси-та-вправи" class="level1">
<h1>Додаткові ресурси та вправи</h1>
<ul>
<li><p><a href="https://twitter.com/tclavl">Тайлер Клавелле</a> написав кілька цікавих <a href="https://www.tylerclavelle.com/blog/">дописів у блозі</a> про взаємодію з API через R.</p></li>
<li><p>Джонатан Регенштайн має чудовий допис у блозі <em>R Views</em> RStudio «<a href="https://rviews.rstudio.com/2018/09/12/gdp-via-api/">Дані про ВВП через API</a>», який подібний шлях до мого прикладу FRED. За винятком того, що він використовує API Бюро економічного аналізу (BEA).</p></li>
<li><p>Грег Реда “<a href="http://www.gregreda.com/2015/02/15/web-scraping-finding-the-api/">Web Scraping 201: Finding the API</a>” охоплює майже те саме, що й ми тут. Хоча він зосереджується на інструментах Python, я знайшов це зручним довідником протягом багатьох років. (Ви також можете переглянути попередні публікації в серії вебскрапінгу Грега — <a href="http://www.gregreda.com/2013/03/03/web-scraping-101-with-python/">Частина 1</a> і <a href="http://www.gregreda.com/2013/04/29/more-web-scraping-with-python/">Частина 2</a> — щоб побачити деякі еквіваленти Python інструментів <code>rvest</code>, якими ми користувався.)</p></li>
<li><p>Ян Лондон (ще один користувач Python) має чудову публікацію в блозі на тему «<a href="https://ianlondon.github.io/blog/web-scraping-discovering-hidden-apis/">Виявлення прихованих API</a>» від Airbnb.</p></li>
<li><p>І нарешті, хоча методи, розглянуті в останніх двох лекціях, повинні задовольнити 95% (99%?) ваших потреб у вебскрапінгу, є деякі випадки, коли вони не спрацюють. Зокрема, ви можете зіткнутися з випадками, коли вміст веб-сайту відображається динамічно за допомогою JavaScript. У такі часи вам доведеться запустити так званий «headless» браузер, щоб отримати вміст.</p></li>
</ul>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Цікавий факт: ряд пакетів R, які ми використовуватимемо пізніше в цьому курсі (наприклад, <strong>leaflet</strong>, <strong>plotly</strong> тощо), насправді є просто набором функцій-оболонок, які взаємодіють із основними API та конвертувати ваш код R на іншу мову (наприклад, JavaScript).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>По правді кажучи: щоб уникнути обмежень швидкості — тобто обмеження кількості запитів, які ви можете зробити на годину — найкраще <a href="https://data.cityofnewyork.us/profile/app_tokens">зареєструватися</a>. Ми збираємося зробити лише один або два запити тут, тож все має бути добре.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Подумайте про <em>параметри</em> API так само, як ви думаєте про <em>аргументи</em> функції. Це дійсні вхідні дані (інструкції), які змінюють відповідь на запит API.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>складні вкладені списки є правилом, коли мова йде про інформацію json. Не хвилюйся надто про це зараз; Будьте впевнені, що R добре підходить для роботи з такими об’єктами. Це одна з причин, чому R і json так добре поєднуються.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Те саме стосується скомпільованих документів Quarto, таких як ці конспекти лекцій.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Оскільки нова змінна середовища R визначена на тривалість поточного сеансу, Quarto матиме доступ до цієї змінної, незалежно від того, чи була вона визначена в Quarto чи ні.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Зверніть увагу, що URL-адреса не змінюється, навіть якщо ми вибираємо іншу дату в календарі.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>XHR означає <strong>X</strong>ML<strong>H</strong>ttp<strong>R</strong>запит і є типом запиту, який використовується для отримання даних XML або JSON.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Я знаю, що R каже, що <code>rugby$entries</code> є data.frame, але ми можемо викликати <code>str()</code>, що він слідує структурі списку. Зокрема, піделемент <code>rugby$entries$team</code> сам по собі є фреймом даних.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Знову ж таки, не надто турбуйтеся про це зараз. Ми докладніше розглянемо ітерацію та програмування в наступній лекції.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>